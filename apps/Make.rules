# vim: set ft=make noet:
# Assembler, linker and scripts
TOP = ../..
include $(TOP)/Make.default
-include $(TOP)/Make.local

CC = cl65  # override this for apps.

CFG = $(TOP)/apps/apps.cfg
INCLUDES += --asm-include-dir $(TOP)/inc
INCLUDES += -I $(TOP)/apps/lib
LIB = $(TOP)/apps/lib/build/sfoslib.lib

# Assembler flags
# Compiler flags
CFLAGS = \
	--feature labels_without_colons \
	--feature string_escapes \
	--cpu $(CPU) \
	-t none \
	-O \
	-Ln $(BUILD_DIR)/$(APPNAME).sym \
	-C $(CFG) \
	-m $(BUILD_DIR)/$(APPNAME).map \
	$(INCLUDES) \
	-l $(BUILD_DIR)/$(APPNAME).lst

LOAD_ADDR = 800

BUILD_DIR = build

OBJS = $(addprefix $(BUILD_DIR)/, $(SOURCES:.s=.o))

all: $(BUILD_DIR)/$(APPNAME).com

clean:
	rm -fr $(BUILD_DIR)

$(BUILD_DIR)/$(APPNAME).raw: $(SOURCES) $(C_SOURCES)
	@mkdir -p $$(dirname $@)
	$(CC) $(CFLAGS) -o $@ $^ $(LIB)

$(BUILD_DIR)/$(APPNAME).com: $(BUILD_DIR)/$(APPNAME).raw
	$(LOADTRIM) build/$(APPNAME).raw build/$(APPNAME).com $(LOAD_ADDR)
